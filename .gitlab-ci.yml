stages:
  - build
  - publish
    
cache: &global_cache
  key: $CI_COMMIT_REF_SLUG
  paths:
    - .yarn/cache
  policy: pull-push

build_package:
  stage: build
  image: node:16-bullseye
  cache:
    <<: *global_cache
  artifacts:
    expire_in: 1 days
    paths:
      - dist
  only:
    - tags
  script:
    - yarn install
    - yarn build
      
publish_to_npm:
  stage: publish
  image: node:16-bullseye
  cache:
    <<: *global_cache
    policy: pull
  dependencies:
    - build_package
  only:
    - tags
  script:
    - npm config set -- '//registry.npmjs.org/:_authToken' "${NPMJS_TOKEN}"
    - (cd dist && npm publish --access public)